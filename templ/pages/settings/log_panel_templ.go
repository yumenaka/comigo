// Code generated by templ - DO NOT EDIT.

// templ: version: v0.3.977
package settings

//lint:file-ignore SA4006 This context is only used if a nested component is present.

import "github.com/a-h/templ"
import templruntime "github.com/a-h/templ/runtime"

// 服务器日志面板，使用 SSE 实时显示后端日志，并允许发送全局广播消息
func LogPanel() templ.Component {
	return templruntime.GeneratedTemplate(func(templ_7745c5c3_Input templruntime.GeneratedComponentInput) (templ_7745c5c3_Err error) {
		templ_7745c5c3_W, ctx := templ_7745c5c3_Input.Writer, templ_7745c5c3_Input.Context
		if templ_7745c5c3_CtxErr := ctx.Err(); templ_7745c5c3_CtxErr != nil {
			return templ_7745c5c3_CtxErr
		}
		templ_7745c5c3_Buffer, templ_7745c5c3_IsBuffer := templruntime.GetBuffer(templ_7745c5c3_W)
		if !templ_7745c5c3_IsBuffer {
			defer func() {
				templ_7745c5c3_BufErr := templruntime.ReleaseBuffer(templ_7745c5c3_Buffer)
				if templ_7745c5c3_Err == nil {
					templ_7745c5c3_Err = templ_7745c5c3_BufErr
				}
			}()
		}
		ctx = templ.InitializeContext(ctx)
		templ_7745c5c3_Var1 := templ.GetChildren(ctx)
		if templ_7745c5c3_Var1 == nil {
			templ_7745c5c3_Var1 = templ.NopComponent
		}
		ctx = templ.ClearChildren(ctx)
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 1, "<div id=\"settings_log\" x-data=\"{ collapsed: $persist(true).as('settings_log_collapsed') }\" class=\"flex flex-col justify-start w-full pl-2 pr-4 py-2 mx-2 my-1 font-semibold border rounded shadow-md hover:shadow-2xl items-left bg-base-100 text-base-content border-slate-400\"><!-- 折叠/展开按钮 --><button @click=\"collapsed = !collapsed\" class=\"flex justify-between items-center w-full cursor-pointer px-2 py-1.5\"><svg class=\"w-5 h-5 transition-transform\" :class=\"{ '-rotate-90': collapsed }\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 10 6\"><path stroke=\"currentColor\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"m1 1 4 4 4-4\"></path></svg> <span x-text=\"i18next.t('settings_log_title')\" class=\"flex-1 text-center font-semibold\">服务器实时日志</span> <svg class=\"w-5 h-5 transition-transform\" :class=\"{ 'rotate-90': collapsed }\" xmlns=\"http://www.w3.org/2000/svg\" fill=\"none\" viewBox=\"0 0 10 6\"><path stroke=\"currentColor\" stroke-linecap=\"round\" stroke-linejoin=\"round\" stroke-width=\"2\" d=\"m1 1 4 4 4-4\"></path></svg></button><hr x-show=\"!collapsed\" class=\"my-1 mx-4 h-2 border-gray-600 border-dashed dark:border-gray-200\"><!-- 可折叠内容 --><div x-show=\"!collapsed\" x-transition><div id=\"log_panel\" class=\"w-full h-[400px] p-4 mt-1 bg-gray-900 text-sm text-white rounded overflow-y-auto overflow-x-hidden whitespace-pre-wrap break-all\"><!-- 日志内容将通过 JavaScript 动态插入 --></div><!-- 发送信息按钮，目前用不着，隐藏 --><div class=\"hidden flex items-center justify-center w-full px-2 pt-3\"><input id=\"msg\" placeholder=\"输入广播消息\" x-bind:placeholder=\"i18next.t('settings_log_broadcast_placeholder')\" class=\"flex-1 min-w-0 px-2 py-1 h-10 rounded text-base-content bg-base-200 border border-base-300\"> <button id=\"send\" class=\"ml-2 p-1 h-10 w-24 text-center text-gray-700 transition border border-gray-500 rounded bg-sky-300 active:bg-sky-500 hover:text-gray-900\"><span x-text=\"i18next.t('settings_log_broadcast_send')\">POST</span></button></div></div></div><script>\n\t\t// 日志内容着色函数\n\t\t// text-green-600 : oklch(62.7% 0.194 149.214)\n\t\t// text-red-600 oklch(57.7% 0.245 27.325)\n\t\t// text-orange-600  oklch(64.6% 0.222 41.116)\n\t\tfunction colorize(log) {\n\t\t\treturn log\n\t\t\t\t.replace(\n\t\t\t\t\t/\\[GET:200\\]/g,\n\t\t\t\t\t'<span style=\"color:oklch(62.7% 0.194 149.214)\">[GET:200]</span>',\n\t\t\t\t)\n\t\t\t\t.replace(\n\t\t\t\t\t/\\[ERROR\\]/g,\n\t\t\t\t\t'<span style=\"color:oklch(57.7% 0.245 27.325)\">[ERROR]</span>',\n\t\t\t\t)\n\t\t\t\t.replace(\n\t\t\t\t\t/\\[WARN\\]/g,\n\t\t\t\t\t'<span style=\"color:oklch(64.6% 0.222 41.116)\">[WARN]</span>',\n\t\t\t\t)\n\t\t\t\t.replace(\n\t\t\t\t\t/\\[INFO\\]/g,\n\t\t\t\t\t'<span style=\"color:oklch(62.7% 0.194 149.214)\">[INFO]</span>',\n\t\t\t\t)\n\t\t\t\t.replace(/\\[DEBUG\\]/g, '<span style=\"color:gray\">[DEBUG]</span>');\n\t\t}\n\t\t// 日志输出函数（性能优化版）：\n\t\t// - 不再使用 innerHTML +=（会导致整块 HTML 反复重建/解析，日志多时直接卡死）\n\t\t// - 批量追加，合并滚动操作\n\t\t// - 限制最大行数，避免 DOM 无限增长\n\t\tconst LOG_MAX_LINES = 2000;\n\t\tconst LOG_FLUSH_INTERVAL_MS = 80;\n\n\t\tconst logBox = () => document.getElementById(\"log_panel\");\n\t\tconst logPending = [];\n\t\tlet logFlushTimer = null;\n\n\t\tfunction isNearBottom(el) {\n\t\t\t// 允许 12px 的误差，避免浮点/滚动条误差导致“吸底”失效\n\t\t\treturn el.scrollTop + el.clientHeight >= el.scrollHeight - 12;\n\t\t}\n\n\t\tfunction pruneLogLines(box) {\n\t\t\t// 以“行”为单位裁剪，保持最近 LOG_MAX_LINES 行\n\t\t\twhile (box.childElementCount > LOG_MAX_LINES) {\n\t\t\t\tbox.removeChild(box.firstElementChild);\n\t\t\t}\n\t\t}\n\n\t\tfunction flushLogs() {\n\t\t\tlogFlushTimer = null;\n\t\t\tconst box = logBox();\n\t\t\tif (!box) return;\n\n\t\t\tconst shouldAutoScroll = isNearBottom(box);\n\t\t\tif (logPending.length === 0) return;\n\n\t\t\t// 用 template 一次性解析新增内容，避免频繁触发重排/回流\n\t\t\tconst tpl = document.createElement(\"template\");\n\t\t\ttpl.innerHTML = logPending\n\t\t\t\t.splice(0, logPending.length)\n\t\t\t\t.map((line) => `<div class=\"log-line\">${line}</div>`)\n\t\t\t\t.join(\"\");\n\t\t\tbox.appendChild(tpl.content);\n\n\t\t\tpruneLogLines(box);\n\n\t\t\tif (shouldAutoScroll) {\n\t\t\t\tbox.scrollTop = box.scrollHeight;\n\t\t\t}\n\t\t}\n\n\t\t// 外部统一调用的 log：入队 + 定时批量 flush\n\t\tconst log = (s) => {\n\t\t\tconst box = logBox();\n\t\t\tif (!box) return;\n\t\t\tlogPending.push(colorize(s));\n\t\t\tif (logFlushTimer) return;\n\t\t\tlogFlushTimer = setTimeout(flushLogs, LOG_FLUSH_INTERVAL_MS);\n\t\t};\n\t\t// 创建 EventSource 连接到后端 SSE API,withCredentials:true 允许携带cookie\n\t\t// https://developer.mozilla.org/zh-CN/docs/Web/API/EventSource\n\t\tconst es = new EventSource(\"/api/sse\", { withCredentials: true });\n\t\tes.onopen = (e) =>\n\t\t\tlog(\n\t\t\t\t`<span style=\"color:oklch(62.7% 0.194 149.214)\">[open]</span> ` +\n\t\t\t\t\ti18next.t(\"settings_log_sse_connected\"),\n\t\t\t);\n\t\tes.onerror = (e) =>\n\t\t\tlog(\n\t\t\t\t`<span style=\"color:oklch(57.7% 0.245 27.325)\">[error]</span> ` +\n\t\t\t\t\t(es.readyState === EventSource.CLOSED\n\t\t\t\t\t\t? i18next.t(\"settings_log_sse_closed\")\n\t\t\t\t\t\t: i18next.t(\"settings_log_sse_retrying\")),\n\t\t\t);\n\t\t// 全局消息事件\n\t\tes.onmessage = (e) => {\n\t\t\tshowToast(e.data, \"info\");\n\t\t\tlog(\n\t\t\t\t`<span style=\"color:oklch(62.7% 0.194 149.214)\">[message]</span>` +\n\t\t\t\t\te.data,\n\t\t\t);\n\t\t};\n\t\t// 监听自定义事件名：tick\n\t\tes.addEventListener(\"tick\", (e) => log(\"[tick] \" + e.data));\n\t\t// 监听后端日志事件：log（Echo 日志中间件通过 SSE 使用 event: log 推送）\n\t\tes.addEventListener(\"log\", (e) => log(e.data));\n\n\t\t// 发送消息按钮的点击事件\n\t\tdocument.getElementById(\"send\").onclick = async () => {\n\t\t\tconst message =\n\t\t\t\tdocument.getElementById(\"msg\").value ||\n\t\t\t\tt(\"settings_log_broadcast_default_message\", \"Hello ~\");\n\t\t\tawait fetch(\"/api/push\", {\n\t\t\t\tmethod: \"POST\",\n\t\t\t\theaders: { \"Content-Type\": \"application/json\" },\n\t\t\t\tbody: JSON.stringify({ message }),\n\t\t\t});\n\t\t\tconsole.log(\"[send] \" + message);\n\t\t};\n\t</script>")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		return nil
	})
}

var _ = templruntime.GeneratedTemplate
