// Code generated by templ - DO NOT EDIT.

// templ: version: v0.3.977
package upload_page

//lint:file-ignore SA4006 This context is only used if a nested component is present.

import "github.com/a-h/templ"
import templruntime "github.com/a-h/templ/runtime"

func UploadArea() templ.Component {
	return templruntime.GeneratedTemplate(func(templ_7745c5c3_Input templruntime.GeneratedComponentInput) (templ_7745c5c3_Err error) {
		templ_7745c5c3_W, ctx := templ_7745c5c3_Input.Writer, templ_7745c5c3_Input.Context
		if templ_7745c5c3_CtxErr := ctx.Err(); templ_7745c5c3_CtxErr != nil {
			return templ_7745c5c3_CtxErr
		}
		templ_7745c5c3_Buffer, templ_7745c5c3_IsBuffer := templruntime.GetBuffer(templ_7745c5c3_W)
		if !templ_7745c5c3_IsBuffer {
			defer func() {
				templ_7745c5c3_BufErr := templruntime.ReleaseBuffer(templ_7745c5c3_Buffer)
				if templ_7745c5c3_Err == nil {
					templ_7745c5c3_Err = templ_7745c5c3_BufErr
				}
			}()
		}
		ctx = templ.InitializeContext(ctx)
		templ_7745c5c3_Var1 := templ.GetChildren(ctx)
		if templ_7745c5c3_Var1 == nil {
			templ_7745c5c3_Var1 = templ.NopComponent
		}
		ctx = templ.ClearChildren(ctx)
		templ_7745c5c3_Err = templruntime.WriteString(templ_7745c5c3_Buffer, 1, "<div class=\"relative w-full max-w-2xl p-8 bg-white rounded shadow-md\"><!-- 书库选择下拉框 --><div class=\"mb-6\"><label class=\"block mb-2 text-sm font-medium text-gray-700\" x-text=\"i18next.t('select_upload_target_store')\">选择上传目标书库</label> <select id=\"store-select\" class=\"w-full px-4 py-2 border border-gray-300 rounded focus:ring-blue-500 focus:border-blue-500\"><option value=\"\" x-text=\"i18next.t('loading')\">加载中...</option></select><p id=\"store-warning\" class=\"mt-2 text-sm text-red-500 hidden\"></p></div><!-- 文件选择与拖拽区域 --><div id=\"drop-area\" class=\"px-6 py-24 text-center transition duration-300 border-4 border-gray-300 border-dashed rounded cursor-pointer hover:border-blue-500\"><p class=\"text-gray-500\" x-text=\"i18next.t('drag_or_click_to_upload')\">>将文件拖拽到此处或点击选择文件</p><input type=\"file\" id=\"file-input\" multiple class=\"hidden\"></div><!-- 预览选中文件列表 --><div id=\"preview\" class=\"mt-6\"><h3 class=\"mb-4 text-lg font-semibold\" x-text=\"i18next.t('selected_file')\">选择的文件</h3><ul class=\"divide-y divide-gray-200\" id=\"file-list\"><!-- 动态插入文件项 --></ul></div><!-- 进度条背景 显示与隐藏有过渡效果，不可点击。--><div id=\"progress-bar\" class=\"absolute pointer-events-none top-0 left-0 h-full transition-opacity duration-500 bg-blue-500/30\" style=\"width: 0%;\"></div><!-- 上传按钮 --><button id=\"upload-button\" class=\"w-full py-2 mt-6 text-white bg-blue-500 rounded hover:bg-blue-600 disabled:bg-blue-300 disabled:cursor-not-allowed\" disabled x-text=\"i18next.t('upload_file')\">上传文件</button><!-- 上传结果显示区域 --><div id=\"result\" class=\"mt-4\"></div></div><div class=\"grow bg-gray-400 place-holder\"></div><script>\n\t\t// 获取元素\n\t\tconst dropArea = document.getElementById(\"drop-area\");\n\t\tconst fileInput = document.getElementById(\"file-input\");\n\t\tconst fileList = document.getElementById(\"file-list\");\n\t\tconst uploadButton = document.getElementById(\"upload-button\");\n\t\tconst resultDiv = document.getElementById(\"result\");\n\t\tconst progressBar = document.getElementById(\"progress-bar\");\n\t\tconst storeSelect = document.getElementById(\"store-select\");\n\t\tconst storeWarning = document.getElementById(\"store-warning\");\n\t\t// 保存选中的文件\n\t\tlet filesToUpload = [];\n\t\t// 保存可用的书库列表\n\t\tlet availableStores = [];\n\n\t\t// localStorage key，与 $persist 的命名风格保持一致\n\t\tconst LAST_STORE_KEY = \"_x_upload.lastSelectedStore\";\n\n\t\t// 获取上次选择的书库\n\t\tfunction getLastSelectedStore() {\n\t\t\ttry {\n\t\t\t\tconst stored = localStorage.getItem(LAST_STORE_KEY);\n\t\t\t\treturn stored ? JSON.parse(stored) : null;\n\t\t\t} catch (e) {\n\t\t\t\treturn null;\n\t\t\t}\n\t\t}\n\n\t\t// 保存选择的书库\n\t\tfunction saveSelectedStore(storeUrl) {\n\t\t\ttry {\n\t\t\t\tlocalStorage.setItem(LAST_STORE_KEY, JSON.stringify(storeUrl));\n\t\t\t} catch (e) {\n\t\t\t\tconsole.warn(\"无法保存书库选择到 localStorage:\", e);\n\t\t\t}\n\t\t}\n\n\t\t// 获取书库列表的函数\n\t\tfunction loadStores() {\n\t\t\tfetch(\"/api/stores\")\n\t\t\t\t.then((response) => response.json())\n\t\t\t\t.then((data) => {\n\t\t\t\t\tconst stores = data.stores || [];\n\t\t\t\t\tstoreSelect.innerHTML = \"\"; // 清空加载提示\n\t\t\t\t\tavailableStores = []; // 重置可用书库列表\n\n\t\t\t\t\tif (stores.length === 0) {\n\t\t\t\t\t\t// 没有配置书库，显示设置提示\n\t\t\t\t\t\tconst option = document.createElement(\"option\");\n\t\t\t\t\t\toption.value = \"\";\n\t\t\t\t\t\toption.textContent = i18next.t(\"no_available_stores\");\n\t\t\t\t\t\toption.disabled = true;\n\t\t\t\t\t\tstoreSelect.appendChild(option);\n\t\t\t\t\t\t// 显示更详细的提示，引导用户去设置书库\n\t\t\t\t\t\tstoreWarning.innerHTML =\n\t\t\t\t\t\t\ti18next.t(\"no_available_stores\") +\n\t\t\t\t\t\t\t' <a href=\"/settings\" class=\"text-blue-500 underline hover:text-blue-700\">' +\n\t\t\t\t\t\t\ti18next.t(\"settings_stores\") +\n\t\t\t\t\t\t\t\"</a>\";\n\t\t\t\t\t\tstoreWarning.classList.remove(\"hidden\");\n\t\t\t\t\t\t// 禁用拖拽区域和上传按钮\n\t\t\t\t\t\tuploadButton.disabled = true;\n\t\t\t\t\t\tdropArea.classList.add(\"opacity-50\", \"pointer-events-none\");\n\t\t\t\t\t\treturn;\n\t\t\t\t\t}\n\n\t\t\t\t\t// 填充书库选项，找出第一个可用书库\n\t\t\t\t\tlet firstAvailableStore = null;\n\t\t\t\t\tstores.forEach((store) => {\n\t\t\t\t\t\tconst option = document.createElement(\"option\");\n\t\t\t\t\t\toption.value = store.url;\n\t\t\t\t\t\tif (store.exists) {\n\t\t\t\t\t\t\toption.textContent = store.name;\n\t\t\t\t\t\t\tavailableStores.push(store.url);\n\t\t\t\t\t\t\t// 记录第一个可用书库\n\t\t\t\t\t\t\tif (firstAvailableStore === null) {\n\t\t\t\t\t\t\t\tfirstAvailableStore = store.url;\n\t\t\t\t\t\t\t}\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\toption.textContent =\n\t\t\t\t\t\t\t\tstore.name + \" (\" + i18next.t(\"store_not_exists\") + \")\";\n\t\t\t\t\t\t\toption.disabled = true;\n\t\t\t\t\t\t}\n\t\t\t\t\t\tstoreSelect.appendChild(option);\n\t\t\t\t\t});\n\n\t\t\t\t\t// 检查是否有可用书库\n\t\t\t\t\tif (availableStores.length === 0) {\n\t\t\t\t\t\t// 所有书库路径都不存在\n\t\t\t\t\t\tstoreWarning.innerHTML =\n\t\t\t\t\t\t\ti18next.t(\"no_available_stores\") +\n\t\t\t\t\t\t\t' <a href=\"/settings\" class=\"text-blue-500 underline hover:text-blue-700\">' +\n\t\t\t\t\t\t\ti18next.t(\"settings_stores\") +\n\t\t\t\t\t\t\t\"</a>\";\n\t\t\t\t\t\tstoreWarning.classList.remove(\"hidden\");\n\t\t\t\t\t\tuploadButton.disabled = true;\n\t\t\t\t\t\tdropArea.classList.add(\"opacity-50\", \"pointer-events-none\");\n\t\t\t\t\t} else {\n\t\t\t\t\t\t// 尝试恢复上次选择的书库\n\t\t\t\t\t\tconst lastStore = getLastSelectedStore();\n\t\t\t\t\t\t// 检查上次选择的书库是否还在可用列表中\n\t\t\t\t\t\tif (lastStore && availableStores.includes(lastStore)) {\n\t\t\t\t\t\t\tstoreSelect.value = lastStore;\n\t\t\t\t\t\t} else {\n\t\t\t\t\t\t\t// 如果上次选择的书库不可用，使用第一个可用书库\n\t\t\t\t\t\t\tstoreSelect.value = firstAvailableStore;\n\t\t\t\t\t\t\t// 更新存储\n\t\t\t\t\t\t\tsaveSelectedStore(firstAvailableStore);\n\t\t\t\t\t\t}\n\t\t\t\t\t\tstoreWarning.classList.add(\"hidden\");\n\t\t\t\t\t\tdropArea.classList.remove(\"opacity-50\", \"pointer-events-none\");\n\t\t\t\t\t\t// 更新上传按钮状态\n\t\t\t\t\t\tupdateUploadButtonState();\n\t\t\t\t\t}\n\t\t\t\t})\n\t\t\t\t.catch((error) => {\n\t\t\t\t\tconsole.error(\"获取书库列表失败:\", error);\n\t\t\t\t\tstoreSelect.innerHTML = \"\";\n\t\t\t\t\tconst option = document.createElement(\"option\");\n\t\t\t\t\toption.value = \"\";\n\t\t\t\t\toption.textContent = i18next.t(\"upload_failed_network_error\");\n\t\t\t\t\toption.disabled = true;\n\t\t\t\t\tstoreSelect.appendChild(option);\n\t\t\t\t\tstoreWarning.textContent = i18next.t(\"upload_failed_network_error\");\n\t\t\t\t\tstoreWarning.classList.remove(\"hidden\");\n\t\t\t\t\tuploadButton.disabled = true;\n\t\t\t\t\tdropArea.classList.add(\"opacity-50\", \"pointer-events-none\");\n\t\t\t\t});\n\t\t}\n\n\t\t// 确保 i18next 初始化完成后再加载书库\n\t\t// 检查 i18next 是否已初始化\n\t\tfunction initUploadPage() {\n\t\t\tif (typeof i18next !== \"undefined\" && i18next.isInitialized) {\n\t\t\t\tloadStores();\n\t\t\t} else if (typeof i18next !== \"undefined\") {\n\t\t\t\t// i18next 存在但未初始化，等待初始化完成\n\t\t\t\ti18next.on(\"initialized\", loadStores);\n\t\t\t} else {\n\t\t\t\t// i18next 还未加载，等待 DOMContentLoaded 后重试\n\t\t\t\tsetTimeout(initUploadPage, 50);\n\t\t\t}\n\t\t}\n\n\t\t// 页面加载完成后初始化\n\t\tif (document.readyState === \"loading\") {\n\t\t\tdocument.addEventListener(\"DOMContentLoaded\", initUploadPage);\n\t\t} else {\n\t\t\t// DOMContentLoaded 已触发\n\t\t\tinitUploadPage();\n\t\t}\n\t\t// 触发文件选择对话框\n\t\tdropArea.addEventListener(\"click\", () => {\n\t\t\tfileInput.click();\n\t\t});\n\t\t// 处理文件选择\n\t\tfileInput.addEventListener(\"change\", (e) => {\n\t\t\thandleFiles(e.target.files);\n\t\t\tfileInput.value = \"\"; // 重置文件输入\n\t\t});\n\t\t// 处理拖拽事件\n\t\t[\"dragenter\", \"dragover\"].forEach((eventName) => {\n\t\t\tdropArea.addEventListener(\n\t\t\t\teventName,\n\t\t\t\t(e) => {\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\te.stopPropagation();\n\t\t\t\t\tdropArea.classList.add(\"drag-over\");\n\t\t\t\t},\n\t\t\t\tfalse,\n\t\t\t);\n\t\t});\n\t\t// 取消拖拽样式\n\t\t[\"dragleave\", \"drop\"].forEach((eventName) => {\n\t\t\tdropArea.addEventListener(\n\t\t\t\teventName,\n\t\t\t\t(e) => {\n\t\t\t\t\te.preventDefault();\n\t\t\t\t\te.stopPropagation();\n\t\t\t\t\tdropArea.classList.remove(\"drag-over\");\n\t\t\t\t},\n\t\t\t\tfalse,\n\t\t\t);\n\t\t});\n\t\t// 处理文件拖拽\n\t\tdropArea.addEventListener(\"drop\", (e) => {\n\t\t\tconst dt = e.dataTransfer;\n\t\t\tconst files = dt.files;\n\t\t\thandleFiles(files);\n\t\t});\n\t\t// 处理选中的文件\n\t\tfunction handleFiles(files) {\n\t\t\tfor (let file of files) {\n\t\t\t\t// 避免重复添加\n\t\t\t\tif (\n\t\t\t\t\t!filesToUpload.some(\n\t\t\t\t\t\t(f) =>\n\t\t\t\t\t\t\tf.name === file.name &&\n\t\t\t\t\t\t\tf.size === file.size &&\n\t\t\t\t\t\t\tf.lastModified === file.lastModified,\n\t\t\t\t\t)\n\t\t\t\t) {\n\t\t\t\t\tfilesToUpload.push(file);\n\t\t\t\t\taddFileToList(file);\n\t\t\t\t}\n\t\t\t}\n\t\t\t// 更新上传按钮状态\n\t\t\tupdateUploadButtonState();\n\t\t}\n\n\t\t// 将文件添加到预览列表\n\t\tfunction addFileToList(file) {\n\t\t\t// 创建文件项\n\t\t\tconst li = document.createElement(\"li\");\n\t\t\tli.className = \"py-2 flex items-center justify-between\";\n\t\t\t// 文件信息\n\t\t\tconst infoDiv = document.createElement(\"div\");\n\t\t\tinfoDiv.className = \"flex items-center\";\n\t\t\t// 如果是图片，显示缩略图\n\t\t\tif (file.type.startsWith(\"image/\")) {\n\t\t\t\tconst img = document.createElement(\"img\");\n\t\t\t\timg.className = \"w-12 h-12 object-cover mr-4 rounded\";\n\t\t\t\timg.src = URL.createObjectURL(file);\n\t\t\t\timg.onload = () => URL.revokeObjectURL(img.src); // 释放内存\n\t\t\t\tinfoDiv.appendChild(img);\n\t\t\t}\n\t\t\t// 选择文件详情\n\t\t\tconst detailsDiv = document.createElement(\"div\");\n\t\t\t// 文件名\n\t\t\tconst fileName = document.createElement(\"p\");\n\t\t\tfileName.className = \"font-medium\";\n\t\t\tfileName.textContent = file.name;\n\t\t\tdetailsDiv.appendChild(fileName);\n\t\t\t// 计算文件大小\n\t\t\tconst fileSize = document.createElement(\"p\");\n\t\t\tfileSize.className = \"text-sm text-gray-500\";\n\t\t\tfileSize.textContent = `${(file.size / 1024).toFixed(2)} KB`;\n\t\t\tif (file.size > 1024 * 1024) {\n\t\t\t\tfileSize.textContent = `${(file.size / 1024 / 1024).toFixed(2)} MB`;\n\t\t\t}\n\t\t\tif (file.size > 1024 * 1024 * 1024) {\n\t\t\t\tfileSize.textContent = `${(file.size / 1024 / 1024 / 1024).toFixed(2)} GB`;\n\t\t\t}\n\t\t\tdetailsDiv.appendChild(fileSize);\n\t\t\t// 文件类型\n\t\t\tinfoDiv.appendChild(detailsDiv);\n\t\t\tli.appendChild(infoDiv);\n\t\t\t// 删除文件按钮\n\t\t\tconst removeBtn = document.createElement(\"button\");\n\t\t\tremoveBtn.className = \"text-red-500 hover:text-red-700\";\n\t\t\tremoveBtn.innerHTML = \"&#10005;\"; // × 符号\n\t\t\tremoveBtn.addEventListener(\"click\", () => {\n\t\t\t\tfilesToUpload = filesToUpload.filter((f) => f !== file);\n\t\t\t\tli.remove();\n\t\t\t\tupdateUploadButtonState();\n\t\t\t});\n\t\t\tli.appendChild(removeBtn);\n\t\t\tfileList.appendChild(li);\n\t\t}\n\t\t// 更新上传按钮的状态\n\t\tfunction updateUploadButtonState() {\n\t\t\tconst storeSelected = storeSelect.value !== \"\";\n\t\t\tconst hasFiles = filesToUpload.length > 0;\n\t\t\tuploadButton.disabled =\n\t\t\t\t!storeSelected || !hasFiles || availableStores.length === 0;\n\t\t}\n\n\t\t// 监听书库选择变化\n\t\tstoreSelect.addEventListener(\"change\", () => {\n\t\t\t// 保存选择到 localStorage\n\t\t\tif (storeSelect.value && availableStores.includes(storeSelect.value)) {\n\t\t\t\tsaveSelectedStore(storeSelect.value);\n\t\t\t}\n\t\t\tupdateUploadButtonState();\n\t\t});\n\t\t// 处理文件上传\n\t\tuploadButton.addEventListener(\"click\", () => {\n\t\t\t// 没有文件不上传\n\t\t\tif (filesToUpload.length === 0) return;\n\t\t\t// 检查是否选择了书库\n\t\t\tconst selectedStore = storeSelect.value;\n\t\t\tif (!selectedStore) {\n\t\t\t\talert(i18next.t(\"select_upload_target_store\"));\n\t\t\t\treturn;\n\t\t\t}\n\t\t\t// 初始化进度条\n\t\t\tprogressBar.style.width = \"0%\";\n\t\t\tprogressBar.style.opacity = \"0.3\";\n\t\t\tuploadButton.textContent = i18next.t(\"upload_file\") + \"0%\";\n\t\t\t// 创建 FormData\n\t\t\tconst formData = new FormData();\n\t\t\tfilesToUpload.forEach((file) => {\n\t\t\t\tformData.append(\"files\", file);\n\t\t\t});\n\t\t\t// 创建 XMLHttpRequest\n\t\t\t// 使用 XMLHttpRequest 来替代 fetch，因为 XMLHttpRequest 提供了上传进度事件，便于实现实时的上传进度显示。\n\t\t\tconst xhr = new XMLHttpRequest();\n\t\t\txhr.open(\n\t\t\t\t\"POST\",\n\t\t\t\t\"/api/upload?store_url=\" + encodeURIComponent(selectedStore),\n\t\t\t\ttrue,\n\t\t\t);\n\t\t\t// 监听上传进度\n\t\t\txhr.upload.addEventListener(\"progress\", (e) => {\n\t\t\t\tif (e.lengthComputable) {\n\t\t\t\t\tconst percentComplete = (e.loaded / e.total) * 100;\n\t\t\t\t\tprogressBar.style.width = `${percentComplete}%`;\n\t\t\t\t\tuploadButton.textContent =\n\t\t\t\t\t\ti18next.t(\"upload_file\") + `${percentComplete.toFixed(2)}%`;\n\t\t\t\t}\n\t\t\t});\n\t\t\t// 监听请求完成\n\t\t\txhr.onload = function () {\n\t\t\t\tif (xhr.status === 200) {\n\t\t\t\t\tconst data = JSON.parse(xhr.responseText);\n\t\t\t\t\tlet filesList = \"\";\n\t\t\t\t\tdata.files.forEach((file) => {\n\t\t\t\t\t\tfilesList += \"<li>\" + file + \"</li>\";\n\t\t\t\t\t});\n\t\t\t\t\tresultDiv.innerHTML =\n\t\t\t\t\t\t'<p class=\"text-green-500 text-lg text-center\">' +\n\t\t\t\t\t\ti18next.t(\"file_uploaded_successfully\") +\n\t\t\t\t\t\t'</p><ul class=\"text-gray-700 list-disc list-inside\">' +\n\t\t\t\t\t\tfilesList +\n\t\t\t\t\t\t\"</ul>\";\n\n\t\t\t\t\t// 提示上传成功\n\t\t\t\t\tshowMessage({\n\t\t\t\t\t\tmessage:\n\t\t\t\t\t\t\tfilesToUpload.length +\n\t\t\t\t\t\t\t\" \" +\n\t\t\t\t\t\t\ti18next.t(\"file_uploaded_successfully\"),\n\t\t\t\t\t\tbuttons: \"confirm\",\n\t\t\t\t\t\tonConfirm: function () {\n\t\t\t\t\t\t\twindow.location.reload();\n\t\t\t\t\t\t},\n\t\t\t\t\t});\n\t\t\t\t\t// 清空文件列表\n\t\t\t\t\tfilesToUpload = [];\n\t\t\t\t\tfileList.innerHTML = \"\";\n\t\t\t\t} else {\n\t\t\t\t\tconst errorData = JSON.parse(xhr.responseText);\n\t\t\t\t\tresultDiv.innerHTML =\n\t\t\t\t\t\t`<p class=\"text-red-500\">` +\n\t\t\t\t\t\ti18next.t(\"upload_failed_network_error\") +\n\t\t\t\t\t\t`</p>`;\n\t\t\t\t}\n\t\t\t\t// 重置上传按钮和进度条\n\t\t\t\tuploadButton.disabled = filesToUpload.length === 0;\n\t\t\t\tuploadButton.textContent = i18next.t(\"upload_file\");\n\t\t\t\t// 隐藏进度条\n\t\t\t\tprogressBar.style.opacity = \"0\";\n\t\t\t};\n\t\t\t// 上传失败: 网络错误\n\t\t\txhr.onerror = function () {\n\t\t\t\tresultDiv.innerHTML =\n\t\t\t\t\t`<p class=\"text-red-500\">` +\n\t\t\t\t\ti18next.t(\"upload_failed_network_error\") +\n\t\t\t\t\t`</p>`;\n\t\t\t\tuploadButton.disabled = filesToUpload.length === 0;\n\t\t\t\tuploadButton.textContent = i18next.t(\"upload_file\");\n\t\t\t\tprogressBar.style.width = \"0%\";\n\t\t\t};\n\t\t\t// 发送请求\n\t\t\tuploadButton.disabled = true;\n\t\t\tuploadButton.textContent = i18next.t(\"uploading\");\n\t\t\txhr.send(formData);\n\t\t});\n\t</script>")
		if templ_7745c5c3_Err != nil {
			return templ_7745c5c3_Err
		}
		return nil
	})
}

var _ = templruntime.GeneratedTemplate
