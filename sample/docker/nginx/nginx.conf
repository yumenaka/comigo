# ============================================================================
# Nginx 配置文件 - Comigo 反向代理
# ============================================================================
# 功能：
#   - 将 /nginx_test/ 路径代理到 comigo 服务
#   - 正确处理所有 API 和静态资源的路径重定向
#   - 通过 sub_filter 修改 HTML 中的绝对路径引用
# ============================================================================

worker_processes auto;
error_log /var/log/nginx/error.log warn;
pid /var/run/nginx.pid;

events {
    worker_connections 1024;
}

http {
    include /etc/nginx/mime.types;
    default_type application/octet-stream;

    log_format main '$remote_addr - $remote_user [$time_local] "$request" '
                    '$status $body_bytes_sent "$http_referer" '
                    '"$http_user_agent" "$http_x_forwarded_for"';

    access_log /var/log/nginx/access.log main;

    sendfile on;
    tcp_nopush on;
    tcp_nodelay on;
    keepalive_timeout 65;
    types_hash_max_size 2048;

    # Gzip 压缩配置
    gzip on;
    gzip_vary on;
    gzip_proxied any;
    gzip_comp_level 6;
    gzip_types text/plain text/css text/xml application/json application/javascript 
               application/rss+xml application/atom+xml image/svg+xml;

    # 上传文件大小限制（根据需要调整）
    client_max_body_size 1024M;

    # 上游服务器配置
    upstream comigo_backend {
        server comigo:1234;
        keepalive 32;
    }

    # WebSocket 连接升级映射
    map $http_upgrade $connection_upgrade {
        default upgrade;
        '' close;
    }

    server {
        listen 80;
        server_name _;

        # ====================================================================
        # /nginx_test/ 二级目录代理配置
        # ====================================================================
        
        # 处理 /nginx_test 重定向到 /nginx_test/
        location = /nginx_test {
            return 301 /nginx_test/;
        }

        # 主代理配置
        location /nginx_test/ {
            # 移除 /nginx_test 前缀后转发到后端
            rewrite ^/nginx_test/(.*)$ /$1 break;
            
            proxy_pass http://comigo_backend;
            
            # 基础代理头设置
            proxy_set_header Host $host;
            proxy_set_header X-Real-IP $remote_addr;
            proxy_set_header X-Forwarded-For $proxy_add_x_forwarded_for;
            proxy_set_header X-Forwarded-Proto $scheme;
            proxy_set_header X-Forwarded-Host $host;
            proxy_set_header X-Forwarded-Port $server_port;
            
            # 告知后端应用使用的基础路径（用于生成正确的 URL）
            proxy_set_header X-Forwarded-Prefix /nginx_test;
            
            # 禁用后端压缩，确保 sub_filter 能正常工作
            proxy_set_header Accept-Encoding "";
            
            # 处理后端返回的 Location 头重定向
            proxy_redirect / /nginx_test/;
            proxy_redirect http://comigo:1234/ /nginx_test/;
            
            # ================================================================
            # 使用 sub_filter 修改 HTML/JS/CSS 响应中的绝对路径
            # 只匹配已知的路径前缀，避免误替换
            # ================================================================
            sub_filter_once off;
            # text/html 是默认值，无需重复声明
            sub_filter_types text/css text/javascript application/javascript 
                             application/x-javascript text/x-javascript application/json;
            
            # ================================================================
            # API 路径 /api/
            # ================================================================
            sub_filter '"/api/' '"/nginx_test/api/';
            sub_filter "'/api/" "'/nginx_test/api/";
            sub_filter '`/api/' '`/nginx_test/api/';
            sub_filter 'url(/api/' 'url(/nginx_test/api/';
            sub_filter 'url("/api/' 'url("/nginx_test/api/';
            # JSON 响应中的 URL 字段
            sub_filter '"url":"/api/' '"url":"/nginx_test/api/';
            sub_filter '"Url":"/api/' '"Url":"/nginx_test/api/';
            
            # ================================================================
            # 页面路径 /scroll/, /flip/, /player/, /shelf/
            # ================================================================
            sub_filter '"/scroll/' '"/nginx_test/scroll/';
            sub_filter "'/scroll/" "'/nginx_test/scroll/";
            sub_filter '`/scroll/' '`/nginx_test/scroll/';
            
            sub_filter '"/flip/' '"/nginx_test/flip/';
            sub_filter "'/flip/" "'/nginx_test/flip/";
            sub_filter '`/flip/' '`/nginx_test/flip/';
            
            sub_filter '"/player/' '"/nginx_test/player/';
            sub_filter "'/player/" "'/nginx_test/player/";
            sub_filter '`/player/' '`/nginx_test/player/';
            
            sub_filter '"/shelf/' '"/nginx_test/shelf/';
            sub_filter "'/shelf/" "'/nginx_test/shelf/";
            
            # ================================================================
            # 静态资源路径 /images/, /script/, /raw/
            # ================================================================
            sub_filter '"/images/' '"/nginx_test/images/';
            sub_filter "'/images/" "'/nginx_test/images/";
            sub_filter 'url(/images/' 'url(/nginx_test/images/';
            sub_filter 'url("/images/' 'url("/nginx_test/images/';
            
            sub_filter '"/script/' '"/nginx_test/script/';
            sub_filter "'/script/" "'/nginx_test/script/";
            
            sub_filter '"/raw/' '"/nginx_test/raw/';
            sub_filter "'/raw/" "'/nginx_test/raw/";
            
            # ================================================================
            # 其他页面路径 /settings, /upload, /login
            # ================================================================
            sub_filter '"/settings' '"/nginx_test/settings';
            sub_filter "'/settings" "'/nginx_test/settings";
            
            sub_filter '"/upload' '"/nginx_test/upload';
            sub_filter "'/upload" "'/nginx_test/upload";
            
            sub_filter '"/login' '"/nginx_test/login';
            sub_filter "'/login" "'/nginx_test/login";
            
            # ================================================================
            # 特殊处理：根路径和 index.html
            # ================================================================
            sub_filter '"/index.html' '"/nginx_test/index.html';
            sub_filter "'/index.html" "'/nginx_test/index.html";
            
            # 缓冲配置
            proxy_buffering on;
            proxy_buffer_size 4k;
            proxy_buffers 8 16k;
            proxy_busy_buffers_size 24k;
            
            # 超时设置
            proxy_connect_timeout 60s;
            proxy_send_timeout 60s;
            proxy_read_timeout 60s;
            
            # HTTP 1.1 支持（用于 keepalive）
            proxy_http_version 1.1;
            proxy_set_header Connection "";

            # WebSocket 支持
            proxy_set_header Upgrade $http_upgrade;
            proxy_set_header Connection $connection_upgrade;
        }

        # 健康检查端点
        location /health {
            access_log off;
            return 200 "OK\n";
            add_header Content-Type text/plain;
        }

        # ====================================================================
        # 将所有已知路径重定向到 /nginx_test/ 前缀
        # 使用 $http_host 保留端口号
        # ====================================================================
        
        # 根路径重定向到 /nginx_test/
        location = / {
            return 301 $scheme://$http_host/nginx_test/;
        }
        
        # API 路径重定向
        location /api/ {
            return 301 $scheme://$http_host/nginx_test$request_uri;
        }
        
        # 页面路径重定向
        location /shelf/ {
            return 301 $scheme://$http_host/nginx_test$request_uri;
        }
        location /scroll/ {
            return 301 $scheme://$http_host/nginx_test$request_uri;
        }
        location /flip/ {
            return 301 $scheme://$http_host/nginx_test$request_uri;
        }
        location /player/ {
            return 301 $scheme://$http_host/nginx_test$request_uri;
        }
        location = /settings {
            return 301 $scheme://$http_host/nginx_test/settings;
        }
        location /settings/ {
            return 301 $scheme://$http_host/nginx_test$request_uri;
        }
        location = /upload {
            return 301 $scheme://$http_host/nginx_test/upload;
        }
        location /upload/ {
            return 301 $scheme://$http_host/nginx_test$request_uri;
        }
        location = /login {
            return 301 $scheme://$http_host/nginx_test/login;
        }
        location /login/ {
            return 301 $scheme://$http_host/nginx_test$request_uri;
        }
        
        # 静态资源路径重定向
        location /images/ {
            return 301 $scheme://$http_host/nginx_test$request_uri;
        }
        location /script/ {
            return 301 $scheme://$http_host/nginx_test$request_uri;
        }
        location /raw/ {
            return 301 $scheme://$http_host/nginx_test$request_uri;
        }
    }
}
